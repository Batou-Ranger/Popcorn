configuration: Release
image: Visual Studio 2017
environment:
  github_token:
    secure: 1gvZRwqsRGWm1ceuynEv1qbN7yfYJLRkcq34hHdvKiC0JGw9ZyzgeoW7c04xn5Lg

assembly_info:
  patch: true
  file: '**\AssemblyInfo.*'
  assembly_version: '$(appveyor_build_version)'
  assembly_file_version: '$(appveyor_build_version)'
  assembly_informational_version: '$(appveyor_build_version)'

before_build:
  - nuget restore

build_script:
  - choco install "msbuild-sonarqube-runner" -y
  - MSBuild.SonarQube.Runner.exe begin /k:"%APPVEYOR_PROJECT_NAME%" /d:"sonar.host.url=https://sonarqube.com" /d:"sonar.organization=%SONAR_ORGANIZATION%" /d:"sonar.login=%SONAR_TOKEN%"
  - msbuild "Popcorn.sln"
  - MSBuild.SonarQube.Runner.exe end /d:"sonar.login=%SONAR_TOKEN%"

test_script:
- ps: >-
    .\packages\opencover\4.7.922\tools\OpenCover.Console.exe -register:user -target:nunit3-console.exe "-targetargs:""Popcorn.Tests\bin\x86\$env:CONFIGURATION\net472\Popcorn.Tests.dll""" -filter:"+[Popcorn*]*" -output:opencoverCoverage.xml

    $coveralls = (Resolve-Path "packages/coveralls.net/0.7.0/tools/csmacnz.coveralls.exe").ToString()
    
    $env:APPVEYOR_BUILD_NUMBER
    
    & $coveralls --opencover -i opencoverCoverage.xml --repoToken $env:COVERALLS_REPO_TOKEN --useRelativePaths --commitId $env:APPVEYOR_REPO_COMMIT --commitBranch $env:APPVEYOR_REPO_BRANCH --commitAuthor $env:APPVEYOR_REPO_COMMIT_AUTHOR --commitEmail $env:APPVEYOR_REPO_COMMIT_AUTHOR_EMAIL --commitMessage $env:APPVEYOR_REPO_COMMIT_MESSAGE --jobId $env:APPVEYOR_BUILD_NUMBER --serviceName appveyor

deploy:
  release: v$(appveyor_build_version)
  description: 'Various improvements & fixes'
  provider: GitHub
  auth_token: $(github_token)
  artifacts: 
  - path: '*.exe'
    name: Popcorn
  - path: '*.msi'
    name: Popcorn
  draft: false
  prerelease: false
  on:
    branch: master
    APPVEYOR_REPO_TAG: true

after_build:
- cmd: >-
    if defined APPVEYOR_REPO_TAG_NAME choco pack .\chocolatey-popcorn.nuspec --version %APPVEYOR_BUILD_VERSION%
    if defined APPVEYOR_REPO_TAG_NAME appveyor PushArtifact %APPVEYOR_REPO_TAG_NAME%.nupkg